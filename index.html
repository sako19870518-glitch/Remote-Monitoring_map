<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>地点マップ（カテゴリ色分け対応）</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  :root{ --bg:#fafafa; --ink:#111; --muted:#6b6b6b; --line:#dcdcdc; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.05)}
  .h{font-weight:800;font-size:18px;margin:0 0 8px}
  .row{display:grid;grid-template-columns: 1fr 1fr 1fr; gap:10px}
  .ctl{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  select,input[type=file],button{height:44px;border:1px solid var(--line);border-radius:10px;font-size:14px;padding:0 10px;background:#fff}
  button{cursor:pointer;font-weight:700}
  #map{height:66vh;border-radius:12px;border:1px solid var(--line);margin-top:12px}

  .toolbar{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; align-items:center}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--line); border-radius:999px; background:#fff}
  .dot{width:14px; height:14px; border-radius:50%}
  .divider{height:1px; background:var(--line); margin:10px 0}

  .footer{color:var(--muted);font-size:12px;margin-top:8px}
  @media (max-width:820px){ .row{grid-template-columns:1fr 1fr} }
  @media (max-width:560px){ .row{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" style="padding:14px 14px 10px">
      <p class="h">地点マップ（Excel/CSV 読込・<b>カテゴリ色分け</b>）</p>
      <div class="row">
        <div class="ctl">
          <label>ファイル（.xlsx / .xls / .csv）</label>
          <input id="file" type="file" accept=".xlsx,.xls,.csv" />
        </div>
        <div class="ctl">
          <label>名称列</label>
          <select id="nameCol"><option value="">未読込</option></select>
        </div>
        <div class="ctl">
          <label>緯度列</label>
          <select id="latCol"><option value="">未読込</option></select>
        </div>
        <div class="ctl">
          <label>経度列</label>
          <select id="lngCol"><option value="">未読込</option></select>
        </div>
        <div class="ctl">
          <label>説明（ポップアップ）列（任意）</label>
          <select id="descCol"><option value="">（なし）</option></select>
        </div>
        <div class="ctl">
          <label>カテゴリ列（色分け & 絞り込み）</label>
          <select id="catCol"><option value="">（なし）</option></select>
        </div>
        <div class="ctl">
          <label>&nbsp;</label>
          <button id="plot">地図に表示</button>
        </div>
      </div>

      <div class="divider"></div>

      <!-- カテゴリ・フィルタUI -->
      <div id="filters" class="toolbar" style="display:none">
        <button id="allOn"  type="button">全選択</button>
        <button id="allOff" type="button">全解除</button>
        <span class="footer">（カテゴリをクリックで表示切替）</span>
      </div>
    </div>

    <div id="map"></div>
    <div class="footer">※ ファイルを選び、列を指定して「地図に表示」。カテゴリ列を選ぶと色分け＆チェックで絞り込みできます。</div>
  </div>

  <!-- libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // Leaflet map 初期化（日本付近）
    const map = L.map('map', { zoomControl: true }).setView([35.0, 135.0], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    let layerGroup = L.layerGroup().addTo(map);

    const $ = s => document.querySelector(s);
    const nameSel = $("#nameCol"), latSel = $("#latCol"), lngSel = $("#lngCol"), descSel = $("#descCol"), catSel = $("#catCol");
    const filtersEl = $("#filters"), btnAllOn = $("#allOn"), btnAllOff = $("#allOff");
    let rows = [];               // 読み込んだデータ
    let markers = [];            // { marker, cat }
    let catState = {};           // { catValue: true/false }
    let catColors = {};          // { catValue: color }

    // 自動認識キー
    const NAME_KEYS = ["名称","名前","地点名","ラベル","名","name","title"];
    const LAT_KEYS  = ["緯度","latitude","lat","Lat","LAT"];
    const LNG_KEYS  = ["経度","longitude","long","lng","Lon","LNG","lon"];
    const CAT_KEYS  = ["カテゴリ","区分","分類","ブロック","系統","班","category","class","group"];

    function fillSelectOptions(headers){
      function fill(sel, firstLabel){
        sel.innerHTML = '';
        const o0 = document.createElement('option');
        o0.value = '';
        o0.textContent = firstLabel;
        sel.appendChild(o0);
        headers.forEach(h=>{
          const o = document.createElement('option');
          o.value = h; o.textContent = h;
          sel.appendChild(o);
        });
      }
      fill(nameSel, "選択してください");
      fill(latSel,  "選択してください");
      fill(lngSel,  "選択してください");
      fill(descSel, "（なし）");
      fill(catSel,  "（なし）");

      function auto(sel, keys){
        const lower = headers.map(h=>h.toString().toLowerCase());
        for(const k of keys){
          const i = lower.indexOf(k.toLowerCase());
          if(i>=0){ sel.value = headers[i]; return; }
        }
      }
      auto(nameSel, NAME_KEYS);
      auto(latSel,  LAT_KEYS);
      auto(lngSel,  LNG_KEYS);
      auto(catSel,  CAT_KEYS);
    }

    // ファイル読込
    $("#file").addEventListener("change", async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type:"array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { defval:"", raw:true });
      if(json.length === 0){ alert("データが空です。1行目をヘッダー、2行目以降にデータを入れてください。"); return; }
      rows = json;
      fillSelectOptions(Object.keys(json[0]));
    });

    // カラーパレット（20色）＋ 足りなければHSLで生成
    const PALETTE = [
      "#e6194b","#3cb44b","#0082c8","#f58231","#911eb4",
      "#46f0f0","#f032e6","#d2f53c","#fabebe","#008080",
      "#e6beff","#aa6e28","#fffac8","#800000","#aaffc3",
      "#808000","#ffd8b1","#000080","#808080","#ffe119"
    ];
    function colorForCategory(cat, index){
      if(catColors[cat]) return catColors[cat];
      const c = index < PALETTE.length ? PALETTE[index] :
        `hsl(${(index*57)%360}deg 75% 45%)`;
      catColors[cat] = c;
      return c;
    }

    function buildFilterUI(cats){
      filtersEl.style.display = cats.length ? "" : "none";
      filtersEl.querySelectorAll(".chip.cat").forEach(el=>el.remove());

      cats.forEach((c, i)=>{
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "chip cat";
        chip.dataset.cat = c;

        const dot = document.createElement("span");
        dot.className = "dot";
        dot.style.background = colorForCategory(c, i);
        chip.appendChild(dot);

        const label = document.createElement("span");
        label.textContent = c || "(空白)";
        chip.appendChild(label);

        // 初期はON
        catState[c] = true;
        chip.style.opacity = "1";

        chip.addEventListener("click", ()=>{
          catState[c] = !catState[c];
          chip.style.opacity = catState[c] ? "1" : ".35";
          applyFilter();
        });

        filtersEl.appendChild(chip);
      });

      btnAllOn.onclick  = ()=>{ Object.keys(catState).forEach(k=>catState[k]=true); filtersEl.querySelectorAll(".chip.cat").forEach(el=>el.style.opacity="1"); applyFilter(); };
      btnAllOff.onclick = ()=>{ Object.keys(catState).forEach(k=>catState[k]=false); filtersEl.querySelectorAll(".chip.cat").forEach(el=>el.style.opacity=".35"); applyFilter(); };
    }

    function applyFilter(){
      layerGroup.clearLayers();
      const visible = [];
      markers.forEach(({marker, cat})=>{
        if(catState[cat] ?? true){
          marker.addTo(layerGroup);
          visible.push(marker);
        }
      });
      if(visible.length){
        const group = L.featureGroup(visible);
        map.fitBounds(group.getBounds().pad(0.2));
      }
    }

    function parseNum(v){
      const n = Number((v ?? "").toString().replace(/[^\d\.\-]/g,""));
      return Number.isFinite(n) ? n : NaN;
    }

    // 地図へ描画
    $("#plot").addEventListener("click", ()=>{
      if(rows.length === 0){ alert("先にファイルを読み込んでください。"); return; }
      const nameKey = nameSel.value, latKey = latSel.value, lngKey = lngSel.value;
      const descKey = descSel.value || null;
      const catKey  = catSel.value  || null;
      if(!nameKey || !latKey || !lngKey){ alert("名称・緯度・経度の列を選択してください。"); return; }

      layerGroup.clearLayers();
      markers = [];
      catState = {};
      catColors = {};

      // カテゴリ一覧を先に集計
      let cats = [];
      if(catKey){
        cats = [...new Set(rows.map(r => (r[catKey] ?? "").toString().trim()))];
      }

      const ms = [];
      rows.forEach((r)=>{
        const name = (r[nameKey] ?? "").toString().trim();
        const lat  = parseNum(r[latKey]);
        const lng  = parseNum(r[lngKey]);
        const desc = descKey ? (r[descKey] ?? "").toString() : "";
        const cat  = catKey ? (r[catKey] ?? "").toString().trim() : "";

        if(!name || !Number.isFinite(lat) || !Number.isFinite(lng)) return;

        const color = catKey ? colorForCategory(cat, cats.indexOf(cat)) : "#1976d2";
        const m = L.circleMarker([lat, lng], {
          radius: 7, color, fillColor: color, fillOpacity: 0.85, weight: 1.5
        }).bindPopup(`<b>${name}</b>${desc?`<br>${desc}`:''}${catKey?`<br><small style="color:#666">カテゴリ: ${cat||"(空白)"}</small>`:''}`);

        markers.push({ marker: m, cat });
        ms.push(m);
      });

      if(ms.length === 0){
        alert("有効な行がありません（緯度・経度・名称を確認）。");
        filtersEl.style.display = "none";
        return;
      }

      // すべてONで開始、UI作成
      if(catKey) buildFilterUI(cats); else filtersEl.style.display = "none";

      // 追加＆ズーム
      ms.forEach(m => m.addTo(layerGroup));
      const group = L.featureGroup(ms);
      map.fitBounds(group.getBounds().pad(0.2));
    });
  </script>
</body>
</html>
